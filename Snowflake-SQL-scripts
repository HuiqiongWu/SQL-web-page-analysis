--PROJECT
--CREATE NEW DIMDATE TABLE
CREATE OR REPLACE TRANSIENT TABLE "PLAYGROUND"."BF_DEV".A7_DIMDATE_HUIQIONGWU LIKE  "ASSIGNMENT"."AS_PROD"."DIMDATE";

ALTER TABLE "PLAYGROUND"."BF_DEV".A7_DIMDATE_HUIQIONGWU
DROP COLUMN SPANISHDAYNAMEOFWEEK, FRENCHDAYNAMEOFWEEK, SPANISHMONTHNAME, FRENCHMONTHNAME, FISCALYEAR, FISCALQUARTER, FISCALSEMESTER;

SELECT * FROM "PLAYGROUND"."BF_DEV".A7_DIMDATE_HUIQIONGWU;

--INSERT DIMDATE TABLE'S DATA INTO NEW DIMDATE TABLE
INSERT INTO "PLAYGROUND"."BF_DEV".A7_DIMDATE_HUIQIONGWU 
    SELECT 
       DATEKEY, 
       FULLDATEALTERNATEKEY, 
       DAYNUMBEROFWEEK,  
       ENGLISHDAYNAMEOFWEEK,
       DAYNUMBEROFMONTH,
       DAYNUMBEROFYEAR,
       WEEKNUMBEROFYEAR,
       ENGLISHMONTHNAME,
       MONTHNUMBEROFYEAR,
       CALENDARQUARTER,
       CALENDARYEAR,
       CALENDARSEMESTER
       FROM "ASSIGNMENT"."AS_PROD"."DIMDATE";
       
--CHECK DATA IN NEW DIMDATE TABLE
SELECT * FROM "PLAYGROUND"."BF_DEV".A7_DIMDATE_HUIQIONGWU;
SHOW COLUMNS IN TABLE "PLAYGROUND"."BF_DEV".A7_DIMDATE_HUIQIONGWU;

--CHANGE TABLE POLICY TO NULLABLE
ALTER TABLE "PLAYGROUND"."BF_DEV".A7_DIMDATE_HUIQIONGWU
ALTER  DATEKEY DROP NOT NULL
       ,DAYNUMBEROFWEEK DROP NOT NULL
       ,ENGLISHDAYNAMEOFWEEK DROP NOT NULL
       ,DAYNUMBEROFMONTH DROP NOT NULL
       ,DAYNUMBEROFYEAR DROP NOT NULL
       ,WEEKNUMBEROFYEAR DROP NOT NULL
       ,ENGLISHMONTHNAME DROP NOT NULL
       ,MONTHNUMBEROFYEAR DROP NOT NULL
       ,CALENDARQUARTER DROP NOT NULL
       ,CALENDARYEAR DROP NOT NULL
       ,CALENDARSEMESTER DROP NOT NULL;
       
--GENERATE DATES FROM A DATE RANGE AND INSERT THEM INTO NEW DIMDATE TABLE
INSERT INTO "PLAYGROUND"."BF_DEV".A7_DIMDATE_HUIQIONGWU(FULLDATEALTERNATEKEY)
WITH 
DATE_RANGE AS (
  SELECT TO_DATE('2030-12-31','YYYY-MM-DD') ,DATEADD(DAY, -1*SEQ4(), TO_DATE('2030-12-31','YYYY-MM-DD') ) AS MY_DATE
    FROM TABLE(GENERATOR(ROWCOUNT => (5844) ))
 )
  SELECT MY_DATE FROM DATE_RANGE ORDER BY 1 ASC;

--DERIVE OTHER FILEDS

CREATE PROCEDURE UPDATEFIELDS(info TABLE)
RETURNS TABLE
LANGUAGE sql
$$
BEGIN
    ALTER SESSION SET WEEK_OF_YEAR_POLICY=1, WEEK_START=7;
    UPDATE "PLAYGROUND"."BF_DEV".A7_DIMDATE_HUIQIONGWU
    SET 
        DATEKEY = TO_VARCHAR(FULLDATEALTERNATEKEY,'yyyymmdd')
        ,DAYNUMBEROFWEEK = DAYOFWEEK(FULLDATEALTERNATEKEY)
        ,DAYNUMBEROFYEAR = DAYOFYEAR(FULLDATEALTERNATEKEY)
        ,ENGLISHDAYNAMEOFWEEK = CASE DAYOFWEEKd(FULLDATEALTERNATEKEY) WHEN 1 THEN 'Sunday'
                                                WHEN 2 THEN 'Monday'
                                                WHEN 3 THEN 'Tuesday'
                                                WHEN 4 THEN 'Wednesday'
                                                WHEN 5 THEN 'Thursday'
                                                WHEN 6 THEN 'Friday'
                                                WHEN 7 THEN 'Saturday' END
        ,DAYNUMBEROFMONTH = DAYOFMONTH(FULLDATEALTERNATEKEY)
        ,WEEKNUMBEROFYEAR = DATE_PART(WEEK, TO_DATE(FULLDATEALTERNATEKEY))
        ,ENGLISHMONTHNAME = CASE MONTH(FULLDATEALTERNATEKEY) WHEN 1 THEN 'January'
                                                        WHEN 2 THEN 'February'
                                                        WHEN 3 THEN 'March'
                                                        WHEN 4 THEN 'April'
                                                        WHEN 5 THEN 'May'
                                                        WHEN 6 THEN 'June'
                                                        WHEN 7 THEN 'July'
                                                        WHEN 8 THEN 'August'
                                                        WHEN 9 THEN 'September'
                                                        WHEN 10 THEN 'October'
                                                        WHEN 11 THEN 'November'
                                                        WHEN 12 THEN 'December' END
    ,MONTHNUMBEROFYEAR = MONTH(FULLDATEALTERNATEKEY)
    ,CALENDARQUARTER = DATE_PART(quarter, TO_DATE(FULLDATEALTERNATEKEY))
    ,CALENDARYEAR = YEAR(FULLDATEALTERNATEKEY)
    ,CALENDARSEMESTER = CASE WHEN MONTH(FULLDATEALTERNATEKEY) <7 THEN 1 ELSE 2 END
    WHERE FULLDATEALTERNATEKEY > TO_DATE('2014-12-31');
END;
$$
;

--CHECK DATA AGAIN
SELECT * FROM "PLAYGROUND"."BF_DEV".A7_DIMDATE_HUIQIONGWU;

--UPLOAD DATA TO NEW TABLE PLAYGROUND.BF_DEV.A7_prestg_product_order_trans_HUIQIONGWU
CREATE OR REPLACE TABLE "PLAYGROUND"."BF_DEV".A7_PRESTG_PRODUCT_ORDER_TRANS_HUIQIONGWU (
  ORDERID VARCHAR,
  NAME VARCHAR,
  TRANSACTIONDATE DATETIME,
  TRANSACTIONTYPE VARCHAR,
  QUANTITY INT,
  ACTUALCOST NUMERIC
);

CREATE OR REPLACE file format "PLAYGROUND"."BF_DEV".A7_PRESTG_PRODUCT_ORDER_TRANS_HUIQIONGWU
  type = csv
  RECORD_DELIMITER = '\n' 
  field_delimiter = ','
  FIELD_OPTIONALLY_ENCLOSED_BY='"' --SOLVE THE PROBLEM IF THE DILIMITER ALSO APPEARS IN THE FIELD VALUES
  skip_header = 1
  null_if = ('NULL', 'null')
  empty_field_as_null = true;

SELECT * FROM "PLAYGROUND"."BF_DEV".A6_PRESTG_PRODUCT_INFO_HUIQIONGWU;

--CREATE NEW TABLE PLAYGROUND.BF_PROD_dimdate_HUIQIONGWU

CREATE TABLE "PLAYGROUND"."BF_PROD".dimdate_HUIQIONGWU CLONE "PLAYGROUND"."BF_DEV"."A7_DIMDATE_HUIQIONGWU";

--CREATE NEW TABLE PLAYGROUND.BF_PROD_dim_product_HUIQIONGWU
SELECT FULLDATEALTERNATEKEY FROM "PLAYGROUND"."BF_DEV".A7_DIMDATE_HUIQIONGWU;
SHOW COLUMNS IN TABLE  "PLAYGROUND"."BF_DEV".A7_DIMDATE_HUIQIONGWU;
CREATE OR REPLACE TABLE "PLAYGROUND"."BF_PROD".dim_product_HUIQIONGWU LIKE "PLAYGROUND"."BF_DEV".A6_PRESTG_PRODUCT_INFO_HUIQIONGWU;
ALTER TABLE "PLAYGROUND"."BF_PROD".dim_product_HUIQIONGWU ADD PRODUCT_ID INT IDENTITY(1,1) NOT NULL; -- ADD PRODUCT_ID COLUMN WITH AUTOINCREMENT

create transient table TempTable1 AS
SELECT * 
FROM "PLAYGROUND"."BF_PROD".dim_product_HUIQIONGWU;
/* Drop the columns that are not needed */
ALTER TABLE TempTable1
DROP COLUMN PRODUCT_ID;
/* Get results and drop temp table */
SELECT * FROM TempTable1
EXCEPT
SELECT * FROM "PLAYGROUND"."BF_DEV".A6_PRESTG_PRODUCT_INFO_HUIQIONGWU;


DROP TABLE TempTable1;

--INSERT GENERATED ID INTO PRODUCT_ID
SELECT * FROM "PLAYGROUND"."BF_DEV".A7_DIMDATE_HUIQIONGWU;

INSERT INTO "PLAYGROUND"."BF_PROD".dim_product_HUIQIONGWU(NAME, PRODUCTNUMBER, MAKEFLAG, FINISHEDGOODSFLAG, COLOR, 
                                                          SAFETYSTOCKLEVEL, REORDERPOINT, STANDARDCOST, LISTPRICE,
                                                         SIZE, SIZEUNITMEASURECODE, WEIGHTUNITMEASURECODE, WEIGHT, DAYSTOMANUFACTURE, PRODUCTLINE, 
                                                          CLASS, STYLE, PRODUCTSUBCATEGORYID, PRODUCTMODELID,SELLSTARTDATE, SELLENDDATE, DISCONTINUEDDATE,
                                                         MODIFIEDDATE) SELECT * FROM "PLAYGROUND"."BF_DEV".A6_PRESTG_PRODUCT_INFO_HUIQIONGWU;
ALTER TABLE "PLAYGROUND"."BF_PROD".dim_product_HUIQIONGWU ADD PRIMARY KEY (PRODUCT_ID);


DESCRIBE TABLE "PLAYGROUND"."BF_PROD".dim_product_HUIQIONGWU;
--CREATE NEW TABLE PLAYGROUND.BF_PROD.prestg_product_order_HUIQIONGWU
SELECT * FROM "PLAYGROUND"."BF_DEV".A7_PRESTG_PRODUCT_ORDER_TRANS_HUIQIONGWU;

CREATE OR REPLACE TABLE "PLAYGROUND"."BF_PROD".fact_product_order_HUIQIONGWU LIKE "PLAYGROUND"."BF_DEV".A7_PRESTG_PRODUCT_ORDER_TRANS_HUIQIONGWU;

ALTER TABLE "PLAYGROUND"."BF_PROD".fact_product_order_HUIQIONGWU ADD COLUMN PRODUCT_ID INT;
ALTER TABLE "PLAYGROUND"."BF_PROD".fact_product_order_HUIQIONGWU ADD COLUMN DATEKEY NUMBER;

INSERT INTO "PLAYGROUND"."BF_PROD".fact_product_order_HUIQIONGWU
WITH CTE AS(
   SELECT T2.*, PRODUCT_ID, T3.DATEKEY FROM "PLAYGROUND"."BF_PROD".dim_product_HUIQIONGWU AS T1 
                            RIGHT JOIN "PLAYGROUND"."BF_DEV".A7_PRESTG_PRODUCT_ORDER_TRANS_HUIQIONGWU AS T2 USING(NAME)
                            LEFT JOIN "PLAYGROUND"."BF_DEV".A7_DIMDATE_HUIQIONGWU AS T3 ON T3.FULLDATEALTERNATEKEY=T2.TRANSACTIONDATE)
                
    SELECT * FROM CTE;

ALTER TABLE "PLAYGROUND"."BF_PROD".fact_product_order_HUIQIONGWU 
    ADD FOREIGN KEY (PRODUCT_ID) REFERENCES "PLAYGROUND"."BF_PROD".dim_product_HUIQIONGWU(PRODUCT_ID);
ALTER TABLE "PLAYGROUND"."BF_PROD".fact_product_order_HUIQIONGWU 
    ADD FOREIGN KEY (DATEKEY) REFERENCES "PLAYGROUND"."BF_DEV".A7_DIMDATE_HUIQIONGWU(DATEKEY);

select *
from "PLAYGROUND"."BF_PROD".fact_product_order_HUIQIONGWU T1
left join "PLAYGROUND"."BF_PROD".dim_product_HUIQIONGWU T2 on T1.PRODUCT_ID = T2.PRODUCT_ID
where T1.PRODUCT_ID is null;

select *
from "PLAYGROUND"."BF_PROD".fact_product_order_HUIQIONGWU T1
left join "PLAYGROUND"."BF_DEV".A7_DIMDATE_HUIQIONGWU T2 on T1.DATEKEY = T2.DATEKEY
where T1.DATEKEY is null;


/* Get the data into a temp table */
create transient table TempTable1 AS
SELECT * 
FROM "PLAYGROUND"."BF_PROD".fact_product_order_HUIQIONGWU;
/* Drop the columns that are not needed */
ALTER TABLE TempTable1
DROP COLUMN PRODUCT_ID, DATEKEY;
/* Get results and drop temp table */
SELECT * FROM TempTable1
EXCEPT
SELECT * FROM "PLAYGROUND"."BF_DEV".A7_PRESTG_PRODUCT_ORDER_TRANS_HUIQIONGWU;


DROP TABLE TempTable1;

SELECT * EXCEPT PRODUCT_ID, DATEKEY FROM "PLAYGROUND"."BF_PROD".fact_product_order_HUIQIONGWU
EXCEPT
SELECT * FROM "PLAYGROUND"."BF_DEV".A7_PRESTG_PRODUCT_ORDER_TRANS_HUIQIONGWU;

--Q8
CREATE OR REPLACE TABLE "PLAYGROUND"."BF_DEV".A7_NEW_PRESTG_PRODUCT_ORDER_TRANS_HUIQIONGWU (
  ORDERID VARCHAR,
  NAME VARCHAR,
  TRANSACTIONDATE DATETIME,
  TRANSACTIONTYPE VARCHAR,
  QUANTITY INT,
  ACTUALCOST NUMERIC
);

CREATE OR REPLACE file format "PLAYGROUND"."BF_DEV".A7_PRESTG_PRODUCT_ORDER_TRANS_HUIQIONGWU
  type = csv
  RECORD_DELIMITER = '\n' 
  field_delimiter = ','
  FIELD_OPTIONALLY_ENCLOSED_BY='"' --SOLVE THE PROBLEM IF THE DILIMITER ALSO APPEARS IN THE FIELD VALUES
  skip_header = 1
  null_if = ('NULL', 'null')
  empty_field_as_null = true;

INSERT INTO "PLAYGROUND"."BF_PROD".fact_product_order_HUIQIONGWU SELECT * FROM "PLAYGROUND"."BF_DEV".A7_PRESTG_PRODUCT_ORDER_TRANS_HUIQIONGWU;
